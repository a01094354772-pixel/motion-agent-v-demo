<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Agent-V | 보안 체인 통합 관제 플랫폼</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Urbanist:wght@400;700&family=Noto+Sans+KR:wght@300;400;700&display=swap');
        
        body { 
            font-family: 'Urbanist', 'Noto Sans KR', sans-serif; 
            background-color: #050505; 
            color: #e2e8f0; 
            margin: 0; 
            overflow-x: hidden; 
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        
        .neon-border { 
            border: 1px solid rgba(222, 255, 154, 0.2); 
            box-shadow: 0 0 20px rgba(222, 255, 154, 0.05); 
        }
        
        .card { background: #0f0f0f; border-radius: 24px; padding: 30px; border: 1px solid #222; position: relative; }
        .btn-primary { background: #deff9a; color: #000; border: none; padding: 15px 40px; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 16px; transition: 0.2s; display: inline-flex; align-items: center; gap: 10px; }
        .btn-primary:hover { transform: scale(1.02); background: #eaffbd; }
        .btn-primary:disabled { opacity: 0.3; cursor: not-allowed; }

        /* 모달 시스템 */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: #0f0f0f; border: 2px solid #deff9a; padding: 40px; border-radius: 30px; width: 800px; max-width: 95%; position: relative; }
        
        .hash-block { background: #000; border: 1px solid #333; padding: 20px; border-radius: 15px; font-family: 'Courier New', Courier, monospace; font-size: 13px; margin-bottom: 15px; line-height: 1.6; word-break: break-all; }
        .hash-block strong { color: #888; font-size: 11px; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .hash-new { color: #deff9a; font-weight: 700; }

        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: #deff9a; box-shadow: 0 0 15px #deff9a; animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        .grid-square { transition: all 0.2s ease; cursor: pointer; border-radius: 1px; }
        .grid-square:hover { transform: scale(1.8); z-index: 50; outline: 1px solid white; box-shadow: 0 0 20px rgba(255,255,255,0.6); }
        .active-v { background-color: #deff9a !important; }
        .active-f { background-color: #3b82f6 !important; }
        .active-x { background-color: #a855f7 !important; }
        .matched-highlight { animation: pulse-white 1s infinite; transform: scale(2.0) !important; z-index: 100 !important; background-color: #fff !important; }
        @keyframes pulse-white { 0%, 100% { box-shadow: 0 0 10px white; } 50% { box-shadow: 0 0 30px white; } }

        .setup-container { max-width: 800px; margin: 40px auto; text-align: center; }
        .input-box { background: #111; border: 1px solid #333; padding: 18px; border-radius: 15px; width: 100%; max-width: 400px; margin: 10px auto; color: #fff; font-size: 18px; text-align: center; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        const App = () => {
            const [phase, setPhase] = useState('onboarding'); // onboarding, live, analysis
            const [step, setStep] = useState(1);
            const [selectedVehicle, setSelectedVehicle] = useState('Bus');
            const [userData, setUserData] = useState({ name: '송문신', license: '11-02-123456-78', vLid: '' });
            const [opData, setOpData] = useState({ op: '', car: '', carID: '' });
            
            const [prevHash, setPrevHash] = useState("ROOT_HASH_V1_86_INITIAL_ENTRY_POINT_SECURED");
            const [hashModal, setHashModal] = useState({ show: false, title: '', payload: '', newHash: '', callback: null });
            
            const [builtIndices, setBuiltIndices] = useState(new Set());
            const [currentCaseIdx, setCurrentCaseIdx] = useState(-1);
            const [isSimulating, setIsSimulating] = useState(false);

            const STANDARDS = { speed: 60.0, friction: 0.80, latency: 0.10 };
            const MARGINS = { speed: 1.5, friction: 0.05, latency: 0.03 };

            // SHA-256 Mock function
            const calculateHash = async (text) => {
                const msgBuffer = new TextEncoder().encode(text);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
            };

            // --- 1. V-LID 발급 및 해시 암호화 시연 ---
            const sealVLID = async () => {
                const vLid = 'V-LID_' + btoa(encodeURIComponent(userData.name)).substring(0, 8).toUpperCase();
                setUserData(prev => ({ ...prev, vLid }));
                
                const payload = `ISSUANCE:V-LID|HOLDER:${userData.name}|LIC:${userData.license}|TS:${Date.now()}`;
                const newHash = await calculateHash(payload + prevHash);

                setHashModal({
                    show: true,
                    title: 'V-LID CRYPTOGRAPHIC ISSUANCE',
                    desc: '발급된 디지털 면허를 해시체인에 등록하여 위변조를 차단합니다.',
                    payload,
                    newHash: '...ENCRYPTING...',
                    callback: () => setStep(4)
                });

                setTimeout(() => {
                    setHashModal(prev => ({ ...prev, newHash }));
                    setPrevHash(newHash);
                }, 1500);
            };

            // --- 2. 운행 세션 인가 및 해시 암호화 시연 ---
            const sealSession = async (car, id, op) => {
                setOpData({ op, car, carID: id });
                const payload = `SESSION_START|V-LID:${userData.vLid}|VEHICLE:${id}|OP:${op}|TS:${Date.now()}`;
                const newHash = await calculateHash(payload + prevHash);

                setHashModal({
                    show: true,
                    title: 'DRIVING SESSION AUTHORIZED',
                    desc: '선택하신 차량에 대한 운행 권한 세션을 정부 DB와 연동하여 인가합니다.',
                    payload,
                    newHash: '...AUTHORIZING SESSION...',
                    callback: () => setPhase('live')
                });

                setTimeout(() => {
                    setHashModal(prev => ({ ...prev, newHash }));
                    setPrevHash(newHash);
                }, 1500);
            };

            // --- 3. 사고 데이터 무결성 봉인 시연 ---
            const sealIncident = async (data) => {
                const payload = `INCIDENT_REPORT|HOLDER:${userData.name}|VEHICLE:${opData.carID}|TS:${Date.now()}`;
                const newHash = await calculateHash(payload + prevHash);

                setHashModal({
                    show: true,
                    title: 'ACCIDENT DATA SEALED',
                    desc: '최종 사고 판독 데이터를 해시체인에 연결하여 법적 증거력을 확보합니다.',
                    payload,
                    newHash: '...SEALING EVIDENCE...',
                    callback: () => {} 
                });

                setTimeout(() => {
                    setHashModal(prev => ({ ...prev, newHash }));
                    setPrevHash(newHash);
                }, 1500);
            };

            // --- 데이터 엔진 (1,000 Edge Cases) ---
            const libraryData = useMemo(() => {
                return Array.from({ length: 1000 }, (_, i) => {
                    let s = STANDARDS.speed, f = STANDARDS.friction, l = STANDARDS.latency;
                    const dice = i % 3;
                    if (dice === 0) { l = 0.42 + Math.random() * 0.1; s = 60.5; } // 지연 결함
                    else if (dice === 1) { s = 95 + Math.random() * 20; } // 속도 과실
                    else { f = 0.25 + Math.random() * 0.1; s = 60.5; } // 노면 결함

                    const isNormS = s <= STANDARDS.speed + MARGINS.speed;
                    const isNormF = f >= STANDARDS.friction - MARGINS.friction;
                    const isNormL = l <= STANDARDS.latency + MARGINS.latency;

                    let op, env, oem;
                    if (isNormS && isNormF && isNormL) {
                        op = 33; env = 33; oem = 34;
                    } else {
                        let fixed = 0;
                        if (isNormS) { op = 3; fixed += 3; }
                        if (isNormF) { env = 3; fixed += 3; }
                        if (isNormL) { oem = 3; fixed += 3; }
                        
                        const remain = 100 - fixed;
                        const sD = !isNormS ? Math.pow(s - STANDARDS.speed, 2) : 0;
                        const fD = !isNormF ? Math.pow(STANDARDS.friction - f, 2) * 1000 : 0;
                        const lD = !isNormL ? Math.pow(l - STANDARDS.latency, 2) * 2000 : 0;
                        const sum = sD + fD + lD || 1;

                        if (!isNormS) op = Math.round((sD/sum)*remain);
                        if (!isNormF) env = Math.round((fD/sum)*remain);
                        if (!isNormL) oem = Math.round((lD/sum)*remain);
                    }
                    return { id: i + 1, actual: { speed: s, friction: f, latency: l }, liabilities: { op, env, oem } };
                });
            }, [selectedVehicle]);

            const runSim = () => {
                if (builtIndices.size === 0) return;
                setIsSimulating(true); setCurrentCaseIdx(-1);
                setTimeout(() => {
                    const builtArr = Array.from(builtIndices);
                    const match = builtArr[Math.floor(Math.random() * builtArr.length)];
                    setCurrentCaseIdx(match);
                    setIsSimulating(false);
                    sealIncident(libraryData[match]);
                }, 2000);
            };

            return (
                <div className="p-8 max-w-[1400px] mx-auto min-h-screen flex flex-col">
                    <header className="flex justify-between items-end border-b border-white/10 pb-6 mb-8">
                        <div>
                            <div className="flex items-center gap-3 mb-1">
                                <span className="bg-[#deff9a] text-black text-[10px] font-black px-2 py-0.5 rounded uppercase font-bold tracking-tighter">Chain-of-Trust</span>
                                <h1 className="text-3xl font-black text-white italic tracking-tighter uppercase">Motion Agent-V</h1>
                            </div>
                            <p className="text-slate-500 text-xs font-bold uppercase tracking-widest italic">Autonomous Causal Audit & Verification Infrastructure</p>
                        </div>
                        <div className="text-right">
                            <span className="text-[10px] text-slate-500 font-bold block mb-1 uppercase tracking-tighter">Chain Status</span>
                            <span className="text-[#deff9a] text-sm font-black tracking-widest uppercase">SHA-256 Integrated</span>
                        </div>
                    </header>

                    {phase === 'onboarding' && (
                        <div className="setup-container">
                            {step === 1 && (
                                <div className="card animate-in fade-in zoom-in duration-500">
                                    <h1 className="text-4xl font-black mb-4">아날로그 면허 <span>디지털 등록</span></h1>
                                    <p className="text-slate-400 mb-8 font-medium">본인 확인을 위한 면허 정보를 입력하십시오.</p>
                                    <div className="flex flex-col gap-4 items-center">
                                        <input type="text" className="input-box" value={userData.name} onChange={e=>setUserData({...userData, name:e.target.value})} placeholder="성명" />
                                        <input type="text" className="input-box" value={userData.license} onChange={e=>setUserData({...userData, license:e.target.value})} placeholder="면허번호" />
                                        <button className="btn-primary" onClick={() => setStep(2)}>생체 인증 시작 <i className="fa-solid fa-user-shield"></i></button>
                                    </div>
                                </div>
                            )}
                            {step === 2 && (
                                <div className="card text-center animate-in slide-in-from-bottom-10">
                                    <h1 className="text-3xl font-black mb-8">면허권자 <span>안면 인식</span></h1>
                                    <div className="w-48 h-48 border-4 border-[#deff9a] rounded-full mx-auto relative overflow-hidden mb-8">
                                        <i className="fa-solid fa-user-large text-8xl text-slate-800 mt-10"></i>
                                        <div className="scan-line"></div>
                                    </div>
                                    <p className="text-[#deff9a] font-bold animate-pulse">본인 여부를 대조하고 있습니다...</p>
                                    <button className="btn-primary mt-10" onClick={() => setStep(3)}>검증 완료</button>
                                </div>
                            )}
                            {step === 3 && (
                                <div className="card text-center">
                                    <h1 className="text-3xl font-black mb-8">데이터 <span>무결성 검증</span></h1>
                                    <div className="py-12 flex flex-col items-center gap-6">
                                        <i className="fa-solid fa-shield-halved text-6xl text-[#deff9a]"></i>
                                        <p className="text-slate-300 font-bold">경찰청 공공 DB 대조 결과: [정상]</p>
                                        <button className="btn-primary" onClick={sealVLID}>디지털 V-LID 발급 (Hash Seal)</button>
                                    </div>
                                </div>
                            )}
                            {step === 4 && (
                                <div className="card text-center">
                                    <h1 className="text-3xl font-black mb-8">디지털 ID <span>발급 완료</span></h1>
                                    <div className="bg-black/50 border-2 border-[#deff9a] p-8 rounded-3xl mb-8 text-left">
                                        <h3 className="text-3xl font-black text-white mb-2">{userData.name}</h3>
                                        <code className="text-[#deff9a] font-mono">{userData.vLid}</code>
                                        <p className="text-slate-500 text-[10px] mt-4 font-bold uppercase tracking-widest italic">Identity Sealing Completed on Hashchain</p>
                                    </div>
                                    <button className="btn-primary" onClick={() => setStep(5)}>운영사 및 차량 선택 <i className="fa-solid fa-link"></i></button>
                                </div>
                            )}
                            {step === 5 && (
                                <div className="grid grid-cols-2 gap-6 text-left">
                                    <div className="card">
                                        <h2 className="text-[#deff9a] font-black mb-6 uppercase text-[12px]">Operator Selection</h2>
                                        <div className="flex flex-col gap-4">
                                            <div className="p-6 bg-black border border-white/5 rounded-2xl cursor-pointer hover:border-[#deff9a]" onClick={() => sealSession('Tesla Model 3', 'TS-K-101', '카카오 모빌리티')}>
                                                <h4 className="font-bold">카카오 모빌리티</h4>
                                                <span className="text-[10px] text-slate-500 font-bold uppercase">Tesla Model 3 | TS-K-101</span>
                                            </div>
                                            <div className="p-6 bg-black border border-white/5 rounded-2xl cursor-pointer hover:border-[#3b82f6]" onClick={() => sealSession('Waymo Zephyr', 'WY-U-505', '우버 오토노머스')}>
                                                <h4 className="font-bold">우버 오토노머스</h4>
                                                <span className="text-[10px] text-slate-500 font-bold uppercase">Waymo Zephyr | WY-U-505</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {phase === 'live' && (
                        <div className="grid grid-cols-[1fr_450px] gap-8 flex-grow">
                            <div className="card flex flex-col justify-center items-center text-center bg-gradient-to-b from-[#111] to-black">
                                <i className="fa-solid fa-location-crosshairs text-6xl text-[#deff9a] opacity-20 mb-8"></i>
                                <span className="text-red-500 font-black text-xs tracking-[4px] uppercase mb-4 animate-pulse"><i className="fa-solid fa-satellite"></i> GPS Active</span>
                                <h1 className="text-5xl font-black italic tracking-tighter">상암동 MBC 사옥 정문</h1>
                                <div className="mt-12 bg-[#deff9a]/5 border border-[#deff9a]/20 px-8 py-4 rounded-full">
                                    <span className="text-[#deff9a] text-xs font-black tracking-widest uppercase italic"><i className="fa-solid fa-tower-broadcast"></i> Infrastructure Linked: V2X Protocol Enabled</span>
                                </div>
                            </div>
                            <div className="flex flex-col gap-6">
                                <div className="card">
                                    <h2 className="text-[#deff9a] font-black mb-6 uppercase text-[11px]"><i className="fa-solid fa-microchip"></i> Monitoring</h2>
                                    <div className="bg-black/50 p-6 rounded-2xl border border-white/5 mb-6">
                                        <span className="text-[10px] text-slate-500 font-bold uppercase block mb-1">인증 면허권자</span>
                                        <h3 className="text-2xl font-black text-white">{userData.name}</h3>
                                        <div className="mt-4 pt-4 border-t border-white/5">
                                            <span className="text-[10px] text-slate-500 font-bold uppercase block mb-1">운용 자산 모델</span>
                                            <p className="text-sm font-bold text-slate-300">{opData.car} ({opData.carID})</p>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-white/5 p-4 rounded-xl text-center border border-white/5">
                                            <span className="text-[10px] text-slate-500 font-bold uppercase block">속도</span>
                                            <span className="text-2xl font-black text-white">60.5</span><small className="text-[10px] ml-1">km/h</small>
                                        </div>
                                        <div className="bg-white/5 p-4 rounded-xl text-center border border-white/5">
                                            <span className="text-[10px] text-slate-500 font-bold uppercase block">지연</span>
                                            <span className="text-2xl font-black text-white">0.42</span><small className="text-[10px] ml-1">s</small>
                                        </div>
                                    </div>
                                    <button className="btn-primary w-full mt-6 h-16" onClick={() => { setPhase('analysis'); setBuiltIndices(new Set([0,1,2,3,4,5])); }}>사고 인과 판독 시작 <i className="fa-solid fa-magnifying-glass-chart"></i></button>
                                </div>
                            </div>
                        </div>
                    )}

                    {phase === 'analysis' && (
                        <div className="grid grid-cols-[450px_1fr] gap-10 flex-grow">
                            <aside className="card text-left">
                                <h2 className="text-[#deff9a] font-black mb-8 uppercase text-[11px]"><i className="fa-solid fa-database"></i> Edge Case Library</h2>
                                <div className="grid grid-cols-10 gap-1.5 h-[400px] overflow-y-auto pr-4 custom-scrollbar mb-8">
                                    {libraryData.slice(0, 400).map((item, i) => (
                                        <div key={i} className={`grid-square aspect-square ${builtIndices.has(i) ? 'active-v' : 'bg-white/5'} ${currentCaseIdx === i ? 'matched-highlight' : ''}`} />
                                    ))}
                                </div>
                                <button className="btn-primary w-full h-16" onClick={runSim} disabled={isSimulating}>실제 사고 시뮬레이션 시작 <i className="fa-solid fa-car-burst"></i></button>
                            </aside>
                            
                            <div className="card text-left flex flex-col justify-center">
                                {currentCaseIdx === -1 ? (
                                    <div className="text-center opacity-30">
                                        <i className="fa-solid fa-magnifying-glass-chart text-7xl mb-6"></i>
                                        <h2 className="text-3xl font-black">판독 대기 중...</h2>
                                    </div>
                                ) : (
                                    <div className="animate-in fade-in slide-in-from-bottom-10">
                                        <div className="flex items-center gap-4 mb-8">
                                            <span className="bg-blue-600 px-4 py-1 rounded-full text-[10px] font-black uppercase">정밀 판독 성공</span>
                                            <h2 className="text-3xl font-black uppercase">Case #{String(libraryData[currentCaseIdx].id).padStart(4, '0')} : {libraryData[currentCaseIdx].liabilities.oem > 50 ? "시스템 지연 결함" : "규정 속도 준수 내 불가항력"}</h2>
                                        </div>
                                        
                                        <table className="w-full text-left border-collapse mb-10">
                                            <thead>
                                                <tr className="bg-white/5 text-[10px] font-black text-slate-500 uppercase">
                                                    <th className="p-4">Parameter</th>
                                                    <th className="p-4 text-center">Value</th>
                                                    <th className="p-4 text-right">Contribution</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr className="border-t border-white/5">
                                                    <td className="p-4 font-bold text-slate-300">주행 속도</td>
                                                    <td className="p-4 text-center font-black">{libraryData[currentCaseIdx].actual.speed.toFixed(1)} km/h</td>
                                                    <td className="p-4 text-right text-[#deff9a] font-black text-2xl">{libraryData[currentCaseIdx].liabilities.op}%</td>
                                                </tr>
                                                <tr className="border-t border-white/5">
                                                    <td className="p-4 font-bold text-slate-300">인지 지연</td>
                                                    <td className="p-4 text-center font-black">{libraryData[currentCaseIdx].actual.latency.toFixed(2)} s</td>
                                                    <td className="p-4 text-right text-[#deff9a] font-black text-2xl">{libraryData[currentCaseIdx].liabilities.oem}%</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        
                                        <div className="bg-white/5 p-8 rounded-3xl border border-white/10 italic text-xl leading-relaxed">
                                            "본 사례는 속도가 60.5km/h로 정상 범위 내에 있었으나, 시스템 지연 시간이 0.42s로 표준을 수배 초과함에 따라 발생한 <strong>제조사 알고리즘 결함</strong>으로 판독되었습니다."
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* HASH SEALING MODAL (The Heart of Demonstration) */}
                    {hashModal.show && (
                        <div className="modal-overlay" style={{display: 'flex'}}>
                            <div className="modal-card animate-in zoom-in duration-300">
                                <h2 className="text-2xl font-black mb-6 uppercase flex items-center gap-3">
                                    <i className="fa-solid fa-lock text-[#deff9a]"></i> {hashModal.title}
                                </h2>
                                <p className="text-slate-400 text-sm mb-6 font-medium">{hashModal.desc}</p>
                                
                                <div className="hash-block">
                                    <strong>[Parent Hash Index]</strong>
                                    {prevHash}
                                </div>
                                <div className="hash-block">
                                    <strong>[Current Transaction Payload]</strong>
                                    {hashModal.payload}
                                </div>
                                <div className="hash-block" style={{borderColor: '#deff9a', background: 'rgba(222,255,154,0.02)'}}>
                                    <strong>[Generated Chain Hash]</strong>
                                    <span className={hashModal.newHash.includes('.') ? 'animate-pulse' : 'hash-new'}>
                                        {hashModal.newHash}
                                    </span>
                                </div>
                                
                                <button 
                                    className="btn-primary w-full mt-6" 
                                    disabled={hashModal.newHash.includes('.')}
                                    onClick={() => { setHashModal({ ...hashModal, show: false }); hashModal.callback && hashModal.callback(); }}
                                >
                                    무결성 확인 및 다음 단계로 <i className="fa-solid fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사고 원인 판독 및 통합 관제 v8.3</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;500;700&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-dark: #050505;
            --card-bg: #0f0f0f;
            --neon-green: #deff9a;
            --text-gray: #666;
            --danger: #ef4444;
            --warning: #f59e0b;
            --success: #10b981;
            --accent-blue: #3b82f6;
            --accent-purple: #a855f7;
        }

        body { background-color: var(--bg-dark); color: #f8fafc; font-family: 'Urbanist', 'Noto Sans KR', sans-serif; margin: 0; padding: 20px; overflow-x: hidden; }
        .container { max-width: 1450px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #222; padding-bottom: 15px; margin-bottom: 25px; }
        .brand { font-size: 24px; font-weight: 800; color: var(--neon-green); cursor: pointer; }
        
        .phase-view { display: none; }
        .phase-view.active { display: block; }
        .card { background: var(--card-bg); border-radius: 24px; padding: 30px; border: 1px solid #222; position: relative; }
        h2 { font-size: 16px; margin: 0 0 20px 0; display: flex; align-items: center; gap: 8px; color: #eee; }

        /* 온보딩 FLOW */
        .setup-container { max-width: 1000px; margin: 40px auto; text-align: center; }
        .step-indicator { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .step-dot { width: 10px; height: 10px; border-radius: 50%; background: #222; transition: 0.3s; }
        .step-dot.active { background: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        .input-box { background: #111; border: 1px solid #333; padding: 18px; border-radius: 15px; width: 100%; max-width: 400px; margin: 10px auto; color: #fff; font-size: 18px; text-align: center; }
        .btn-primary { background: var(--neon-green); color: #000; border: none; padding: 15px 40px; border-radius: 12px; font-weight: 800; cursor: pointer; font-size: 16px; margin-top: 20px; transition: 0.2s; display: inline-flex; align-items: center; gap: 10px; }

        /* 생체 인증 스캐너 */
        .face-scanner { width: 180px; height: 180px; border: 2px solid var(--neon-green); border-radius: 50%; margin: 0 auto 20px; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .scan-line { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--neon-green); box-shadow: 0 0 15px var(--neon-green); animation: scan 2s infinite linear; }
        @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

        /* 매칭 UX */
        .operator-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .select-card { background: #111; border: 1px solid #222; padding: 25px; border-radius: 20px; cursor: pointer; transition: 0.2s; text-align: left; }
        .select-card:hover { border-color: var(--neon-green); transform: translateY(-3px); }
        .vehicle-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .vehicle-card { background: #1a1a1a; border: 1px solid #333; padding: 20px; border-radius: 16px; cursor: pointer; text-align: center; }

        /* 실시간 관제 (GPS Focus) */
        .live-layout { display: grid; grid-template-columns: 1fr 450px; gap: 25px; }
        .live-map-area { 
            background: radial-gradient(circle at center, #111 0%, #080808 100%);
            border-radius: 24px; border: 1px solid #222; position: relative; overflow: hidden; 
            height: 580px; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
        }
        .overlay-box { background: rgba(30, 41, 59, 0.2); padding: 40px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 20px; width: 85%; transition: all 0.5s ease; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .gps-display { font-size: 38px; color: #fff; font-weight: 700; margin-top: 15px; letter-spacing: -1px; line-height: 1.3; }
        .gps-label { color: var(--danger); font-weight: 800; font-size: 13px; letter-spacing: 3px; text-transform: uppercase; display: flex; align-items: center; justify-content: center; gap: 8px; }

        .tele-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .tele-item { background: rgba(30, 41, 59, 0.3); padding: 15px; border-radius: 15px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.05); cursor: pointer; transition: 0.3s; }
        .tele-item:hover { border-color: var(--neon-green); transform: translateY(-2px); }
        .tele-v { font-size: 24px; font-weight: 800; display: block; }
        .tele-l { font-size: 10px; color: var(--text-gray); text-transform: uppercase; margin-bottom: 5px; display: block; }

        /* 리포트 레이아웃 */
        #verdict-summary { background: #000; border: 1px solid #222; border-radius: 20px; padding: 25px; margin-top: 20px; }
        .verdict-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 15px; text-align: left; }
        .info-label { font-size: 11px; color: #555; text-transform: uppercase; display: block; }
        .info-value { font-size: 14px; font-weight: 600; color: #eee; }
        .btn-reset-final { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 15px; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 14px; margin-top: 20px; width: 100%; transition: 0.2s; }

        .summary-metric-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; }
        .metric-card { background: #111; padding: 12px; border-radius: 12px; border: 1px solid #222; text-align: center; }
        .metric-v { font-size: 18px; font-weight: 800; display: block; color: var(--neon-green); }
        .metric-l { font-size: 9px; color: var(--text-gray); text-transform: uppercase; margin-top: 5px; }

        /* 모달 시스템 */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: #0f0f0f; border: 2px solid var(--neon-green); padding: 40px; border-radius: 30px; width: 800px; position: relative; }
        .modal-close { position: absolute; top: 30px; right: 30px; color: #555; font-size: 30px; cursor: pointer; }

        .chart-wrapper { height: 350px; margin-bottom: 10px; }
        .dataset-grid { display: grid; grid-template-columns: repeat(50, 1fr); gap: 2px; margin-top: 15px; height: 100px; overflow-y: auto; background: #000; padding: 8px; border-radius: 10px; border: 1px solid #222; }
        .data-dot { width: 100%; padding-bottom: 100%; background: #1a1a1a; border-radius: 1px; }
        .data-dot.matched { border: 2px solid #fff; transform: scale(1.8); z-index: 10; box-shadow: 0 0 15px #fff; }

        .control-group { margin-bottom: 20px; }
        .control-label-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
        .main-label { font-size: 14px; font-weight: 700; color: #fff; }
        .sub-label { font-size: 11px; color: var(--text-gray); }
        .value-display { font-size: 14px; color: var(--neon-green); font-weight: 700; }
        input[type="range"] { width: 100%; accent-color: var(--neon-green); cursor: pointer; }

        /* BATTERY WARNING COLORS */
        .warning-active { border-color: var(--warning) !important; background: rgba(245, 158, 11, 0.1) !important; }
        .warning-text { color: var(--warning) !important; }
        
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="brand" onclick="location.reload()">MOTION AGENT-V | 사고 원인 판독 및 통합 관제</div>
        <div id="session-info-header" style="font-size: 14px; color: var(--text-gray);">세션 인증 대기 중</div>
    </header>

    <!-- PHASE 1: ONBOARDING -->
    <div id="phase-onboarding" class="phase-view active">
        <div class="setup-container">
            <div class="step-indicator">
                <div id="sd-1" class="step-dot active"></div>
                <div id="sd-2" class="step-dot"></div>
                <div id="sd-3" class="step-dot"></div>
                <div id="sd-4" class="step-dot"></div>
                <div id="sd-5" class="step-dot"></div>
            </div>
            <div id="setup-step-1">
                <h1>아날로그 면허 <span>디지털 등록</span></h1>
                <p>본인 확인을 위한 아날로그 면허 정보를 입력하십시오.</p>
                <input type="text" id="owner-name" class="input-box" value="송문신" placeholder="성명">
                <input type="text" id="license-num" class="input-box" value="11-02-123456-78" placeholder="면허번호">
                <button class="btn-primary" onclick="goToStep(2)">본인 생체 인증 시작 <i class="fa-solid fa-user-shield"></i></button>
            </div>
            <div id="setup-step-2" style="display: none;">
                <h1>면허권자 <span>안면 인식</span></h1>
                <div class="face-scanner"><i class="fa-solid fa-user-large" style="font-size: 80px; color: #222;" id="bio-icon"></i><div class="scan-line"></div></div>
                <p id="bio-log" style="color:var(--text-gray); font-size: 14px;">본인 여부를 대조하고 있습니다...</p>
                <div id="bio-success" style="display: none;"><i class="fa-solid fa-circle-check" style="font-size: 40px; color: var(--success); margin-bottom:15px;"></i><h3 style="color:var(--success)">인증 완료</h3><button class="btn-primary" onclick="startDBValidation()">데이터 무결성 검증</button></div>
            </div>
            <div id="setup-step-3" style="display: none;">
                <h1>데이터 <span>무결성 검증</span></h1>
                <div class="card" style="max-width: 450px; margin: 0 auto; text-align: center;"><div id="v-spinner" class="spinner" style="margin: 0 auto 20px;"></div><p id="v-log-text">경찰청 공공 데이터베이스 대조 중...</p><div id="v-success" style="display: none;"><i class="fa-solid fa-shield-halved" style="font-size: 45px; color: var(--success); margin-bottom:15px;"></i><h3 style="color:var(--success)">정상 면허 확인</h3><button class="btn-primary" onclick="goToStep(4)">디지털 V-LID 발급</button></div></div>
            </div>
            <div id="setup-step-4" style="display: none;">
                <h1>디지털 ID <span>발급 완료</span></h1>
                <div class="card" style="max-width: 550px; margin: 30px auto; text-align: left; border: 2px solid var(--neon-green);"><h3 id="display-name" style="font-size:28px;">-</h3><code id="display-v-lid" style="color: var(--neon-green); font-size: 16px; word-break: break-all;">-</code></div>
                <button class="btn-primary" onclick="goToStep(5)">운영사 및 차량 선택 <i class="fa-solid fa-link"></i></button>
            </div>
            <div id="setup-step-5" style="display: none; text-align: left; max-width: 900px; margin: 0 auto;">
                <div id="op-view"><h1>위탁 <span>운영사 선택</span></h1><div class="operator-grid"><div class="select-card" onclick="showFleets('카카오 모빌리티')"><h4>카카오 모빌리티</h4><span>Kakao Mobility Autonomous</span></div><div class="select-card" onclick="showFleets('우버 오토노머스')"><h4>우버 오토노머스</h4><span>Uber Global Fleet</span></div></div></div>
                <div id="fleet-view" style="display: none;"><button onclick="backToOp()" style="background:transparent; border:none; color:var(--text-gray); cursor:pointer; margin-bottom:10px;"><i class="fa-solid fa-chevron-left"></i> 운영사 다시 선택</button><h1><span id="target-op">-</span> <span>보유 차량 리스트</span></h1><div id="vehicle-fleet-list" class="vehicle-grid"></div></div>
            </div>
        </div>
    </div>

    <!-- PHASE 2: LIVE MONITORING -->
    <div id="phase-live" class="phase-view">
        <div class="live-layout">
            <div class="live-map-area" id="map-container">
                <i class="fa-solid fa-location-crosshairs" style="font-size: 60px; color: var(--neon-green); margin-bottom: 25px; opacity: 0.2;"></i>
                <div class="overlay-box">
                    <span class="gps-label"><i class="fa-solid fa-satellite"></i> GPS Real-time Positioning</span>
                    <div id="live-loc" class="gps-display">상암동 엠비씨 사옥 정문</div>
                </div>
                <div style="background: rgba(222, 255, 154, 0.05); padding: 18px 35px; border-radius: 16px; border: 1px solid rgba(222, 255, 154, 0.2);">
                    <span class="tele-l" style="margin: 0; color: var(--neon-green); font-weight: 700;"><i class="fa-solid fa-tower-broadcast"></i> V2X Infrastructure Telemetry Connected</span>
                </div>
                <div id="battery-alert-banner" style="display:none; margin-top: 30px; background: rgba(245, 158, 11, 0.15); padding: 20px; border-radius: 18px; border: 1px solid var(--warning); color: var(--warning); font-weight: 700; animation: pulse 1.5s infinite;">
                    <i class="fa-solid fa-triangle-exclamation" style="margin-right: 8px;"></i> 배터리 정밀 진단 권고 (B_Score: 55.4)
                </div>
            </div>

            <div class="card" style="display:flex; flex-direction:column; justify-content:space-between;">
                <div>
                    <h2><i class="fa-solid fa-microchip"></i> 실시간 통합 관제 상태</h2>
                    <div style="background:#111; padding:25px; border-radius:20px; border:1px solid #222; margin-bottom:15px;">
                        <span class="tele-l">인증 면허권자</span><h3 id="info-name" style="font-size:28px; color:var(--neon-green);">-</h3>
                        <div style="margin-top:15px;"><span class="tele-l">운용 자산 모델</span><p id="info-car" style="font-size:16px; color:#fff;">-</p></div>
                    </div>
                </div>
                <div class="tele-grid">
                    <div class="tele-item"><span class="tele-l">현재 속도</span><span class="tele-v" id="live-speed" style="color:#fff;">0.0</span><span style="font-size:10px; color:#444;">km/h</span></div>
                    <div class="tele-item" id="battery-status-item" onclick="openBatteryDetail()">
                        <span class="tele-l">배터리 점수(B)</span>
                        <span class="tele-v" id="live-bscore" style="color:var(--accent-blue);">24.2</span>
                        <span id="batt-hint" style="font-size:9px; color:var(--neon-green); opacity:0.6;">정밀 분석 클릭</span>
                    </div>
                    <div class="tele-item"><span class="tele-l">물리리스크(L)</span><span class="tele-v" style="color:var(--success)">SAFE</span></div>
                    <div class="tele-item"><span class="tele-l">시스템 무결성</span><span class="tele-v" style="color:var(--success)" id="live-fault">정상</span></div>
                </div>
                <button class="btn-primary" style="width:100%; margin-top:20px; height:60px;" onclick="goToAnalysis()">사고 인과 판독 시작 <i class="fa-solid fa-magnifying-glass-chart"></i></button>
            </div>
        </div>
    </div>

    <!-- PHASE 3: ANALYSIS ENGINE -->
    <div id="phase-analysis" class="phase-view">
        <div class="grid-layout">
            <div class="card">
                <h2>사고 상황 재구성 입력 (Reconstruction)</h2>
                
                <div class="control-group">
                    <div class="control-label-row">
                        <span class="main-label">복원 속도 (Restored Speed)</span>
                        <span class="sub-label">정상(규정): 60.0 km/h</span>
                        <span class="value-display" id="diag-v-speed">60.0 km/h</span>
                    </div>
                    <input type="range" id="i-speed" min="-30" max="30" value="0" oninput="updateInputUI()">
                </div>

                <div class="control-group">
                    <div class="control-label-row">
                        <span class="main-label">노면 상태 (Road Friction)</span>
                        <span class="sub-label">정상: 0.80 μ</span>
                        <span class="value-display" id="diag-v-friction">0.80 μ</span>
                    </div>
                    <input type="range" id="i-friction" min="0.1" max="1.0" step="0.01" value="0.8" oninput="updateInputUI()">
                </div>

                <div class="control-group">
                    <div class="control-label-row">
                        <span class="main-label">시스템 지연 (System Latency)</span>
                        <span class="sub-label">정상: 0.10s</span>
                        <span class="value-display" id="diag-v-sys">0.10s</span>
                    </div>
                    <input type="range" id="i-sys" min="0.01" max="0.5" step="0.01" value="0.1" oninput="updateInputUI()">
                </div>

                <div class="control-group">
                    <div class="control-label-row">
                        <span class="main-label">통신 지연 (Network Latency)</span>
                        <span class="sub-label">정상: 0.10s</span>
                        <span class="value-display" id="diag-v-comm">0.10s</span>
                    </div>
                    <input type="range" id="i-comm" min="0.01" max="0.5" step="0.01" value="0.1" oninput="updateInputUI()">
                </div>
                
                <button class="btn-primary" style="width: 100%;" onclick="runAccidentAndSeal()">사고 판독 및 디지털 증거 확보 시작</button>
                <div style="margin-top: 25px; border-top: 1px solid #222; padding-top:20px;">
                    <div class="dataset-grid" id="dataset-grid"></div>
                    <button class="btn-primary" style="background:#1a1a1a; color:var(--neon-green); border:1px solid; font-size:12px; width:100%;" onclick="generate1000()">1,000개 라이브러리 연동</button>
                </div>
            </div>
            
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>사고 원인 판독 리포트</h2>
                    <div id="match-id" style="font-size:12px; font-weight:700; color:var(--neon-green);">Analysis Result</div>
                </div>
                <div class="chart-wrapper"><canvas id="mainChart"></canvas></div>
                
                <div class="summary-metric-grid">
                    <div class="metric-card"><span class="metric-v" id="sm-speed">0%</span><span class="metric-l">속도 과실</span></div>
                    <div class="metric-card"><span class="metric-v" id="sm-friction">0%</span><span class="metric-l">노면 원인</span></div>
                    <div class="metric-card"><span class="metric-v" id="sm-sys">0%</span><span class="metric-l" id="sm-sys-lab">시스템 결함</span></div>
                    <div class="metric-card"><span class="metric-v" id="sm-comm">0%</span><span class="metric-l" id="sm-comm-lab">통신 지연</span></div>
                </div>

                <div id="verdict-summary">
                    <div class="verdict-info-grid">
                        <div><span class="info-label">운영사</span><span class="info-value" id="v-sum-op">-</span></div>
                        <div><span class="info-value" style="color:var(--accent-blue)" id="v-sum-car">-</span><span class="info-label">배정 차량</span></div>
                        <div><span class="info-label">면허 소유자</span><span class="info-value" id="v-sum-name">-</span></div>
                        <div><span class="info-value" id="v-sum-vlid" style="font-size:10px; color:#666;">-</span><span class="info-label">V-LID</span></div>
                        <!-- 사고 일시 및 장소 행 추가 -->
                        <div style="grid-column: span 2; margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 10px;">
                            <span class="info-label">사고 일시 및 장소 (Timestamp & Geo)</span>
                            <span class="info-value" id="v-sum-context" style="color: var(--warning); font-size: 13px;">-</span>
                        </div>
                    </div>
                    <div id="verdict-text" style="text-align:center; font-weight:700; color:#fff; min-height: 48px; display: flex; align-items: center; justify-content: center;">분석 대기 중...</div>
                    <button class="btn-reset-final" onclick="location.reload()"><i class="fa-solid fa-rotate-left"></i> 처음 화면으로 돌아가기</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- BATTERY MODAL -->
<div id="battery-modal" class="modal-overlay">
    <div class="modal-card">
        <span class="modal-close" onclick="closeBatteryDetail()">&times;</span>
        <h2 style="color:var(--warning); margin-bottom:10px;"><i class="fa-solid fa-battery-bolt"></i> 배터리 정밀 분석 리포트</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
            <div class="card" style="padding:20px; background:#000;">
                <h4 style="margin:0 0 15px 0;">셀별 전압 분포 (Cell Balancing)</h4>
                <div style="height:250px;"><canvas id="cellChart"></canvas></div>
            </div>
            <div class="card" style="padding:20px; background:#000;">
                <h4 style="margin:0 0 15px 0; color: var(--warning);">전기 계통 이상 징후 분석</h4>
                <ul style="list-style:none; padding:0; line-height:2.5; font-size:15px;">
                    <li><span class="info-label">최고 온도:</span> <span class="info-value" style="color:var(--danger);">53.2 °C (Warning)</span></li>
                    <li><span class="info-label">내부 저항:</span> <span class="info-value">14.5 mΩ (Normal)</span></li>
                    <li><span class="info-label">셀 편차:</span> <span class="info-value" style="color:var(--warning);">0.21V (Limit Exceeded)</span></li>
                    <li style="margin-top:15px; border-top:1px solid #222; padding-top:10px;"><span class="info-label">최종 진단:</span> <strong style="color:var(--warning); font-size: 18px;">주의: 7번 셀 전압 불균형 감지</strong></li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- EVIDENCE SEALING MODAL -->
<div id="hash-modal" class="modal-overlay">
    <div class="modal-card">
        <h2 style="color:var(--neon-green); border-bottom: 1px solid #333; padding-bottom:15px; margin-bottom:20px;"><i class="fa-solid fa-lock"></i> DIGITAL EVIDENCE SECURED</h2>
        <p style="font-size:14px; color:#aaa; margin-bottom:20px;">사고 데이터 무결성이 SHA-256 해시체인으로 보전되었습니다.</p>
        <div class="hash-block"><strong>[Incident Payload Block]</strong><br><span id="h-payload">-</span></div>
        <div class="hash-block" style="border-color: var(--success); background: rgba(16, 185, 129, 0.05);"><strong>[SHA-256 Hash Index]</strong><br><span id="h-new" style="color:var(--neon-green); font-weight: 700;">-</span></div>
        <button class="btn-primary" style="width:100%; margin-top:20px;" onclick="closeHashModal()">최종 판독 결과 확인</button>
    </div>
</div>

<script>
    let userData = { name: '', license: '', vLid: '', op: '', car: '', carID: '' };
    let chart, cellChart;
    let dataset = [];
    let prevHash = "E3B0C44298FC1C149AFBF4C8996FB92427AE41E4649B934CA495991B7852B855";
    let liveInterval, gpsInterval;
    let currentAddrIndex = 0;
    let batteryWarningActive = false;
    
    const simulationAddresses = ["서울시 마포구 상암동 1605", "상암동 디지털미디어시티 교차로", "상암동 누리꿈스퀘어", "상암동 월드컵공원 입구"];
    const fleetData = {
        '카카오 모빌리티': [{name:'Tesla Model 3', id:'TS-K-101'}, {name:'Ioniq 6', id:'HY-K-202'}],
        '우버 오토노머스': [{name:'Waymo Zephyr', id:'WY-U-505'}, {name:'Volvo EX90', id:'VV-U-707'}]
    };

    Chart.register(ChartDataLabels);

    function unicodeBase64(str) { return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (match, p1) => String.fromCharCode('0x' + p1))); }
    async function sha256(message) {
        const msgBuffer = new TextEncoder().encode(message);
        const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('').toUpperCase();
    }

    function goToStep(step) {
        document.querySelectorAll('[id^="setup-step-"]').forEach(el => el.style.display = 'none');
        const target = document.getElementById(`setup-step-${step}`);
        if(target) target.style.display = 'block';
        const dots = document.querySelectorAll('.step-dot');
        dots.forEach(d => d.classList.remove('active'));
        for(let i=1; i<=step; i++) { const dot = document.getElementById(`sd-${i}`); if(dot) dot.classList.add('active'); }
        if(step === 2) {
            setTimeout(() => {
                const bioLog = document.getElementById('bio-log');
                const bioSuccess = document.getElementById('bio-success');
                const bioIcon = document.getElementById('bio-icon');
                if(bioLog) { bioLog.innerText = "안면 인증 성공: [송문신] 확인"; bioLog.style.color = "var(--success)"; }
                if(bioSuccess) bioSuccess.style.display = 'block';
                if(bioIcon) bioIcon.style.color = "var(--success)";
            }, 2000);
        }
        if(step === 4) {
            const nameInp = document.getElementById('owner-name');
            const licInp = document.getElementById('license-num');
            userData.name = nameInp.value;
            userData.license = licInp.value;
            userData.vLid = 'V-LID_' + unicodeBase64(userData.name + userData.license).substring(0, 12).toUpperCase();
            document.getElementById('display-name').innerText = userData.name;
            document.getElementById('display-v-lid').innerText = userData.vLid;
        }
    }

    function startDBValidation() {
        goToStep(3);
        setTimeout(() => {
            document.getElementById('v-success').style.display = 'block';
            document.getElementById('v-spinner').style.display = 'none';
            document.getElementById('v-log-text').style.display = 'none';
        }, 1500);
    }

    function showFleets(op) {
        userData.op = op;
        document.getElementById('op-view').style.display = 'none';
        document.getElementById('fleet-view').style.display = 'block';
        document.getElementById('target-op').innerText = op;
        const list = document.getElementById('vehicle-fleet-list');
        list.innerHTML = '';
        fleetData[op].forEach(v => {
            const card = document.createElement('div');
            card.className = 'vehicle-card';
            card.onclick = () => { userData.car = v.name; userData.carID = v.id; activateSession(); };
            card.innerHTML = `<i class="fa-solid fa-car-side"></i><h4>${v.name}</h4><span>HW-ID: ${v.id}</span>`;
            list.appendChild(card);
        });
    }

    function backToOp() { document.getElementById('op-view').style.display = 'block'; document.getElementById('fleet-view').style.display = 'none'; }

    function activateSession() {
        document.getElementById('info-name').innerText = userData.name;
        document.getElementById('info-car').innerText = `${userData.car} (${userData.carID})`;
        document.getElementById('session-info-header').innerHTML = `<i class="fa-solid fa-circle-check" style="color:var(--success)"></i> Active Session: [${userData.name}]`;
        document.getElementById('phase-onboarding').classList.remove('active');
        document.getElementById('phase-live').classList.add('active');
        batteryWarningActive = false;
        liveInterval = setInterval(() => { 
            const speedEl = document.getElementById('live-speed');
            const bscoreEl = document.getElementById('live-bscore');
            const faultEl = document.getElementById('live-fault');
            if(speedEl) speedEl.innerText = (55+Math.random()*8).toFixed(1); 
            if (!batteryWarningActive) {
                let bScore = (22 + Math.random() * 5);
                if (Math.floor(Date.now() / 1000) % 15 === 0) { bScore = 55.4; batteryWarningActive = true; applyBatteryWarning(); }
                if(bscoreEl) bscoreEl.innerText = bScore.toFixed(1);
            }
            if(faultEl) {
                faultEl.innerText = batteryWarningActive ? "주의" : "정상";
                faultEl.style.color = batteryWarningActive ? "var(--warning)" : "var(--success)";
            }
        }, 1000);
        gpsInterval = setInterval(() => {
            currentAddrIndex = (currentAddrIndex + 1) % simulationAddresses.length;
            const locText = document.getElementById('live-loc');
            if(locText) {
                locText.style.opacity = "0";
                setTimeout(() => { locText.innerText = simulationAddresses[currentAddrIndex]; locText.style.opacity = "1"; locText.style.color = "var(--neon-green)"; setTimeout(() => { locText.style.color = "#fff"; }, 1500); }, 500);
            }
        }, 6000);
    }

    function applyBatteryWarning() {
        const item = document.getElementById('battery-status-item');
        const score = document.getElementById('live-bscore');
        const hint = document.getElementById('batt-hint');
        const banner = document.getElementById('battery-alert-banner');
        if(item) item.classList.add('warning-active');
        if(score) score.classList.add('warning-text');
        if(hint) { hint.innerText = "⚠️ 이상 전압 감지됨"; hint.style.opacity = "1"; }
        if(banner) banner.style.display = "block";
    }

    function openBatteryDetail() {
        document.getElementById('battery-modal').style.display = 'flex';
        const ctx = document.getElementById('cellChart').getContext('2d');
        const cellData = [3.8, 3.81, 3.82, 3.79, 3.8, 3.81, 3.61, 3.82, 3.8, 3.79, 3.81, 3.83];
        if (cellChart) cellChart.destroy();
        cellChart = new Chart(ctx, { type: 'bar', data: { labels: Array.from({length: 12}, (_, i) => `C${i+1}`), datasets: [{ data: cellData, backgroundColor: cellData.map(v => v < 3.7 ? '#f59e0b' : '#10b981') }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 3.0, max: 4.2 } }, plugins: { legend: { display: false }, datalabels: { display: false } } } });
    }
    function closeBatteryDetail() { document.getElementById('battery-modal').style.display = 'none'; }

    function goToAnalysis() {
        if(liveInterval) clearInterval(liveInterval); if(gpsInterval) clearInterval(gpsInterval);
        document.getElementById('phase-live').classList.remove('active');
        document.getElementById('phase-analysis').classList.add('active');
        initGrid(); updateInputUI();
    }

    function initGrid() {
        const grid = document.getElementById('dataset-grid'); grid.innerHTML = '';
        for (let i = 0; i < 1000; i++) {
            const dot = document.createElement('div'); dot.className = 'data-dot'; dot.id = `dot-${i}`;
            grid.appendChild(dot);
        }
    }

    function updateInputUI() {
        const s = document.getElementById('i-speed').value;
        const f = document.getElementById('i-friction').value;
        const sy = document.getElementById('i-sys').value;
        const co = document.getElementById('i-comm').value;
        document.getElementById('diag-v-speed').innerText = `${(60 * (1 + parseInt(s)/100)).toFixed(1)} km/h`;
        document.getElementById('diag-v-friction').innerText = `${parseFloat(f).toFixed(2)} μ`;
        document.getElementById('diag-v-sys').innerText = `${parseFloat(sy).toFixed(2)}s`;
        document.getElementById('diag-v-comm').innerText = `${parseFloat(co).toFixed(2)}s`;
    }

    async function runAccidentAndSeal() {
        if (dataset.length === 0) { alert("라이브러리를 먼저 구축해 주세요."); return; }
        
        // 현재 사고 위치와 정확한 시간 캡처
        const accidentLoc = document.getElementById('live-loc').innerText;
        const accidentTime = new Date().toLocaleString('ko-KR', { 
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false 
        });

        const payload = `HOLDER:${userData.name}|LOC:${accidentLoc}|TIME:${accidentTime}|TS:${Date.now()}`;
        const hModal = document.getElementById('hash-modal');
        const hPayload = document.getElementById('h-payload');
        const hNew = document.getElementById('h-new');

        if(hModal && hPayload && hNew) {
            hModal.style.display = 'flex';
            hPayload.innerText = payload;
            const currentHash = await sha256(payload + prevHash);
            setTimeout(() => { hNew.innerText = currentHash; }, 600);
        }
        
        const s = parseInt(document.getElementById('i-speed').value);
        let minVal = Infinity, matchIdx = -1;
        dataset.forEach((data, idx) => { if (Math.abs(s - data.s) < minVal) { minVal = Math.abs(s - data.s); matchIdx = idx; } });
        
        // 리포트 UI 업데이트 함수에 사고 위치와 시간 전달
        showResult(matchIdx, accidentTime, accidentLoc);
    }

    function showResult(idx, time, loc) {
        const res = dataset[idx];
        const sVal = parseInt(document.getElementById('i-speed').value);
        const fVal = parseFloat(document.getElementById('i-friction').value);
        const syVal = parseFloat(document.getElementById('i-sys').value);
        const coVal = parseFloat(document.getElementById('i-comm').value);

        const speedRisk = sVal > 0 ? Math.pow(sVal/10, 2) * 50 : 5;
        const fricRisk = fVal < 0.8 ? (0.8 - fVal) * 150 : 5;
        const sysRisk = syVal > 0.1 ? (syVal - 0.1) * 300 : 5;
        const commRisk = coVal > 0.1 ? (coVal - 0.1) * 200 : 5;
        const totalRisk = speedRisk + fricRisk + sysRisk + commRisk + 15;

        const cSpeed = Math.round(speedRisk / totalRisk * 100);
        const cFric = Math.round(fricRisk / totalRisk * 100);
        const cSys = Math.round(sysRisk / totalRisk * 100);
        const cComm = Math.round(commRisk / totalRisk * 100);

        document.querySelectorAll('.data-dot').forEach(d => d.classList.remove('matched'));
        const dot = document.getElementById(`dot-${idx}`);
        if(dot) dot.classList.add('matched');
        
        document.getElementById('sm-speed').innerText = cSpeed + '%';
        document.getElementById('sm-friction').innerText = cFric + '%';
        document.getElementById('sm-sys').innerText = cSys + '%';
        document.getElementById('sm-comm').innerText = cComm + '%';

        document.getElementById('v-sum-op').innerText = userData.op;
        document.getElementById('v-sum-car').innerText = `${userData.car} (${userData.carID})`;
        document.getElementById('v-sum-name').innerText = userData.name;
        document.getElementById('v-sum-vlid').innerText = userData.vLid;
        
        // 사고 일시 및 장소 표시 (요청 사항)
        const contextEl = document.getElementById('v-sum-context');
        if(contextEl) contextEl.innerText = `${time} | ${loc}`;

        const scores = [
            { id: 'speed', val: cSpeed, color: 'var(--neon-green)', msg: '운영사 주행 과실', isNormal: sVal <= 0 },
            { id: 'friction', val: cFric, color: 'var(--accent-blue)', msg: '환경적 노면 결함', isNormal: fVal >= 0.8 },
            { id: 'sys', val: cSys, color: 'var(--danger)', msg: '제조사 시스템 지연', isNormal: syVal <= 0.1 },
            { id: 'comm', val: cComm, color: 'var(--accent-purple)', msg: '통신망 네트워크 지연', isNormal: coVal <= 0.1 }
        ];

        const maxVal = Math.max(...scores.map(s => s.val));
        const winners = scores.filter(s => s.val === maxVal);
        const allNormal = scores.every(s => s.isNormal);
        
        let finalMsg = "";
        if (allNormal) {
            finalMsg = `최종 판독 결과: <span style="color:var(--success)">정상 운행 내 기초 위험(Inherent Risk) 발생</span><br><small style="font-weight:400; opacity:0.7;">모든 제어 인자가 정상 범위 내에 있었으나 물리적 회피 한계를 초과한 복합 사고임</small>`;
        } else if (winners.length > 1) {
            finalMsg = `최종 판독 결과: <span style="color:#fff">복합적 요인 기여</span> (인자: ${winners.map(w => w.msg.split(' ')[1]).join(' 및 ')})`;
        } else {
            const main = winners[0];
            finalMsg = `최종 판독 결과: <span style="color:${main.color}">${main.val >= 50 ? main.msg + ' 책임' : main.msg + ' 기여도 우세'}</span>`;
        }
        document.getElementById('verdict-text').innerHTML = finalMsg;

        const ctx = document.getElementById('mainChart').getContext('2d');
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
            type: 'bar',
            data: { 
                labels: ['속도', '노면', '시스템', '통신'], 
                datasets: [{ data: [cSpeed, cFric, cSys, cComm], backgroundColor: ['#deff9a', '#3b82f6', '#ef4444', '#a855f7'], borderRadius: 10 }] 
            },
            options: { 
                indexAxis: 'y', responsive: true, maintainAspectRatio: false, 
                plugins: { 
                    legend: { display: false }, 
                    datalabels: { 
                        anchor: 'end', align: 'end', offset: 8, formatter: (v) => v + '%', color: '#fff', font: { weight: 'bold', size: 14 } 
                    } 
                }, 
                scales: { x: { max: 120, display: false }, y: { ticks: { color: '#fff', font: { weight: 'bold' } } } } 
            }
        });
    }

    function generate1000() {
        dataset = [];
        for (let i = 0; i < 1000; i++) {
            const rs = Math.floor(Math.random() * 60 - 30);
            dataset.push({ s: rs }); 
            const dot = document.getElementById(`dot-${i}`); if(dot) dot.style.background = (i % 12 === 0) ? 'var(--danger)' : 'var(--success)';
        }
        alert("1,000개 인과 분석 데이터 연동 완료.");
    }

    function closeHashModal() { document.getElementById('hash-modal').style.display = 'none'; }
    function closeBatteryDetail() { document.getElementById('battery-modal').style.display = 'none'; }
    window.onload = () => { updateInputUI(); };
</script>
</body>
</html>